= Visit module and entity

:Notice: Licensed to the Apache Software Foundation (ASF) under one or more contributor license agreements. See the NOTICE file distributed with this work for additional information regarding copyright ownership. The ASF licenses this file to you under the Apache License, Version 2.0 (the "License"); you may not use this file except in compliance with the License. You may obtain a copy of the License at. http://www.apache.org/licenses/LICENSE-2.0 . Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR  CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations under the License.


Our domain model now consists of the `PetOwner` and `Pet` entities (along with the `PetSpecies`  enum).
In this section we'll add in the `Visit` entity:

include::partial$domain.adoc[]

Also, note that the `Visit` entity is in its own module.
We'll look at the important topic of modularity in later exercises.


[#exercise-5-1-the-visits-module]
== Ex 5.1: The visits module

In this exercise we'll just create an empty visits module.

=== Solution

[source,bash]
----
git checkout tags/05-01-visit-module
mvn clean install
mvn -pl spring-boot:run
----

=== Tasks

To save time, just checkout the solution tag above and review the git history to see the files and classes that were created:

* A new `simpleapp-jpa-module-visit` maven module was defined in the top-level `pom.xml`

* the `pom.xml` for the new visit module itself was created, and referenced from the top-level `pom.xml` as a child `<module>`

* a `VisitModule` class was created, defining the module to Causeway as a Spring `@Configuration`:
+
[source,java]
.VisitModule.java
----
@Configuration
@Import({
        CausewayModuleExtPdfjsApplib.class,
        CausewayModuleExtFullCalendarApplib.class,
        CausewayModuleTestingFakeDataApplib.class,
        CausewayModulePersistenceJpaApplib.class,
})
@ComponentScan
@EnableJpaRepositories
@EntityScan(basePackageClasses = {VisitModule.class})
public class VisitModule implements ModuleWithFixtures {

    public static final String NAMESPACE = "visit";
    public static final String SCHEMA = "visit";

    @Override
    public FixtureScript getTeardownFixture() {
        return new TeardownFixtureJpaAbstract() {
            @Override
            protected void execute(ExecutionContext executionContext) {
            }
        };
    }
}
----

* the top-level `application.properties` was updated to ensure that the new `visit` schema is created (when running with an in-memory database)
+
[source,properties]
.application.properties
----
causeway.persistence.schema.auto-create-schemas=\
    petowner,visit,simple,...
----


[#exercise-5-2-visit-module-dependencies]
== Ex 5.2: Visit Module Dependencies


Although we have a visit module, it currently is unaware of the pet owner module.
And similarly, the top-level application doesn't yet know about visit module.

In this exercise we'll fix this, so that:

application -> visit module -> petowner module



=== Solution

[source,bash]
----
git checkout tags/05-02-visit-module-dependencies
mvn clean install
mvn -pl spring-boot:run
----

=== tasks

* in the new visit module's `pom.xml`, add a Maven dependency on `petowner` module:
+
[source,xml]
.visit/pom.xml
----
<dependency>
    <groupId>org.apache.causeway.starters</groupId>
    <artifactId>simpleapp-jpa-module-petowner</artifactId>
</dependency>
----
+
TIP: In your IDE you may need to reload/refresh dependencies to rebuild the classpath.

* in the `VisitModule` Causeway module, add a corresponding import on `PetOwnerModule`:
+
[source,java]
.VisitModule.java
----
@Configuration
@Import({
        PetOwnerModule.class,
        // ...
})
// ...
public class VisitModule ... { ... }
----

* in the webapp module, add a Maven dependency on the visit module:
[source,xml]
.visit/pom.xml
----
<dependency>
    <groupId>org.apache.causeway.starters</groupId>
    <artifactId>simpleapp-jpa-module-visit</artifactId>
</dependency>
----
+
The dependency on `<artifactId>simpleapp-jpa-module-petowner</artifactId>` can also be removed, due to transitivity.

* and in the webapp's `ApplicationModule` Causeway module, add a corresponding import on `VisitModule`.
+
[source,java]
.ApplicationModule.java
----
@Configuration
@Import({
        VisitModule.class,
        SimpleModule.class,
})
@ComponentScan
public class ApplicationModule {
}
----
+
The import on `PetOwnerModule.class` can be removed, due to transitivity.

Run the application and check that it starts ok.


[#exercise-5-3-visit-entitys-key-properties]
== Ex 5.3: Visit entity's key properties

Now we have a visits module, we can now add in the `Visit` entity.
We'll start just with the key properties.


=== Solution

[source,bash]
----
git checkout tags/05-03-visit-entity-key-properties
mvn clean install
mvn -pl spring-boot:run
----


=== Tasks

* add a `Visit` entity (in the `dom.visit` subpackage), declaring the `pet` and `visitAt` key properties:
+
[source,java]
.Visit.java
----
@Entity
@Table(
        schema=VisitModule.SCHEMA,
        uniqueConstraints = {
                @UniqueConstraint(name = "Visit__pet_visitAt__UNQ", columnNames = {"pet_id", "visitAt"})
        }
)
@EntityListeners(CausewayEntityListener.class)
@Named(VisitModule.NAMESPACE + ".Visit")
@DomainObject(entityChangePublishing = Publishing.ENABLED)
@DomainObjectLayout()
@NoArgsConstructor(access = AccessLevel.PUBLIC)
@XmlJavaTypeAdapter(PersistentEntityAdapter.class)
@ToString(onlyExplicitlyIncluded = true)
public class Visit implements Comparable<Visit> {

    @Id
    @GeneratedValue(strategy = GenerationType.AUTO)
    @Column(name = "id", nullable = false)
    @Getter @Setter
    private Long id;

    @Version
    @Column(name = "version", nullable = false)
    @PropertyLayout(fieldSetId = "metadata", sequence = "999")
    @Getter @Setter
    private long version;

    Visit(Pet pet, LocalDateTime visitAt) {
        this.pet = pet;
        this.visitAt = visitAt;
    }

    @ObjectSupport
    public String title() {
        return titleService.titleOf(getPet())       // <.>
                + " @ "
                + getVisitAt().format(DateTimeFormatter.ofPattern("dd-MM-yyyy HH:mm"));
    }

    @ManyToOne(optional = false)
    @JoinColumn(name = "pet_id")
    @PropertyLayout(fieldSetId = "identity", sequence = "1")
    @Getter @Setter
    private Pet pet;

    @Column(name = "visitAt", nullable = false)
    @Getter @Setter
    @PropertyLayout(fieldSetId = "identity", sequence = "2")
    private LocalDateTime visitAt;


    private final static Comparator<Visit> comparator =
            Comparator.comparing(Visit::getPet).thenComparing(Visit::getVisitAt);

    @Override
    public int compareTo(final Visit other) {
        return comparator.compare(this, other);
    }

    @Inject @Transient TitleService titleService;   // <1>
}
----
<.> uses the injected xref:refguide:applib:index/services/title/TitleService.adoc[] to obtain the title of the object, as determined by the framework.

* create a `Visit.layout.xml` layout file:
+
[source,xml]
.Visit.layout.xml
----
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<bs3:grid
        xsi:schemaLocation="https://causeway.apache.org/applib/layout/component https://causeway.apache.org/applib/layout/component/component.xsd https://causeway.apache.org/applib/layout/grid/bootstrap3 https://causeway.apache.org/applib/layout/grid/bootstrap3/bootstrap3.xsd"
        xmlns:cpt="https://causeway.apache.org/applib/layout/component"
        xmlns:bs3="https://causeway.apache.org/applib/layout/grid/bootstrap3"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
    <bs3:row>
        <bs3:col span="12" unreferencedActions="true">
            <cpt:domainObject bookmarking="AS_ROOT"/>
        </bs3:col>
    </bs3:row>
    <bs3:row>
        <bs3:col span="6">
            <bs3:row>
                <bs3:col span="12">
                    <bs3:tabGroup>
                        <bs3:tab name="Identity">
                            <bs3:row>
                                <bs3:col span="12">
                                    <cpt:fieldSet name="Identity" id="identity"/>
                                </bs3:col>
                            </bs3:row>
                        </bs3:tab>
                        <bs3:tab name="Other">
                            <bs3:row>
                                <bs3:col span="12">
                                    <cpt:fieldSet name="Other" id="other" unreferencedProperties="true"/>
                                </bs3:col>
                            </bs3:row>
                        </bs3:tab>
                        <bs3:tab name="Metadata">
                            <bs3:row>
                                <bs3:col span="12">
                                    <cpt:fieldSet name="Metadata" id="metadata"/>
                                </bs3:col>
                            </bs3:row>
                        </bs3:tab>
                    </bs3:tabGroup>
                </bs3:col>
                <bs3:col span="12">
                    <cpt:fieldSet name="Details" id="details"/>
                </bs3:col>
            </bs3:row>
        </bs3:col>
        <bs3:col span="6">
            <bs3:row>
                <bs3:col span="12">
                </bs3:col>
            </bs3:row>
            <bs3:tabGroup  unreferencedCollections="true">
            </bs3:tabGroup>
        </bs3:col>
    </bs3:row>
</bs3:grid>
----

* create a `Visit.columnOrder.txt` file
+
[source,text]
.Visit.columnOrder.txt
----
pet
visitAt
#id
#version
----

* download a `Visit.png` file.



Run the application, and login as `secman-admin`/`pass` to confirm that the table is created correctly using menu:Prototyping[H2 Console].
Also check that the unique index has been created correctly.

image::05-02/Visit-entity.png[]



[#exercise-5-3-book-visit-action]
== Ex 5.3: "Book Visit" action

We now want to extend our domain model so that ``Visit``s to be created.

However, there's a problem:

* we would like that behaviour to reside on `PetOwner` (say)
* however the pet owner module doesn't know about visits.

We can see this in the domain model:

include::partial$domain.adoc[]

Causeway's solution to this is to allow the visit module to define behaviour, but have the behaviour seem to belong to the `Pet` entity, at least so far as the user interface is concerned.
This is done using a xref:userguide::mixins.adoc[].


=== Solution

[source,bash]
----
git checkout tags/05-03-book-visit-action
mvn clean install
mvn -pl spring-boot:run
----



=== Tasks



[#exercise-5-4-capture-visit-reason]
== Ex 5.3: Capture visit reason

In addition to the key properties, the `Visit` has one further mandatory property, `reason`.
This is required to be specified when a `Visit` is created ("what is the purpose of this visit?")

In this exercise we'll extend the "book visit" action to also capture that reason.


[source,bash]
----
git checkout tags/05-03-schedule-visit-action
mvn clean install
mvn -pl spring-boot:run
----


=== Tasks

* add the `@Reason` meta-annotation
+
[source,java]
.Reason.java
----
@Property(maxLength = Reason.MAX_LEN)
@PropertyLayout(named = "Reason")
@Parameter(maxLength = Reason.MAX_LEN)
@ParameterLayout(named = "Reason")
@Target({ ElementType.METHOD, ElementType.FIELD, ElementType.PARAMETER, ElementType.ANNOTATION_TYPE })
@Retention(RetentionPolicy.RUNTIME)
public @interface Reason {

    int MAX_LEN = 255;
}
----

* add the `reason` mandatory property:
+
[source,java]
.Visit.java
----
@Reason
@Column(name = "reason", length = FirstName.MAX_LEN, nullable = false)
@Getter @Setter
@PropertyLayout(fieldSetId = "details", sequence = "1")
private String reason;
----


* update constructor (as this is a mandatory property)
+
[source,java]
.Visit.java
----
Visit(Pet pet, LocalDateTime visitAt, String reason) {
    this.pet = pet;
    this.visitAt = visitAt;
    this.reason = reason;
}
----

* create a "visits" mixin collection as a mixin of `Pet`, so we can see the ``Visit``s that have been booked:
+
[source,java]
.Pet_visits.java
----
@Collection
@CollectionLayout(defaultView = "table")
@RequiredArgsConstructor
public class Pet_visits {

    private final Pet pet;

    public List<Visit> coll() {
        return visitRepository.findByPetOrderByVisitAtDesc(pet);
    }

    @Inject VisitRepository visitRepository;
}
----

* create a "bookVisit" mixin action (in the visits module), as a mixin of `Pet`.
+
We can use xref:refguide:applib:index/services/clock/ClockService.adoc[ClockService] to ensure that the date/time specified is in the future, and to set a default date/time for "tomorrow"
+
[source,java]
.Pet_bookVisit.java
----
@Action(
        semantics = SemanticsOf.IDEMPOTENT,
        commandPublishing = Publishing.ENABLED,
        executionPublishing = Publishing.ENABLED
)
@ActionLayout(associateWith = "visits", sequence = "1")
@RequiredArgsConstructor
public class Pet_bookVisit {

    private final Pet pet;

    public Visit act(
            LocalDateTime visitAt,
            @Reason final String reason
            ) {
        return repositoryService.persist(new Visit(pet, visitAt, reason));
    }
    public String validate0Act(LocalDateTime visitAt) {
        return clockService.getClock().nowAsLocalDateTime().isBefore(visitAt)   // <.>
                ? null
                : "Must be in the future";
    }
    public LocalDateTime default0Act() {
        return clockService.getClock().nowAsLocalDateTime()                     // <.>
                .toLocalDate()
                .plusDays(1)
                .atTime(LocalTime.of(9, 0));
    }

    @Inject ClockService clockService;
    @Inject RepositoryService repositoryService;
}
----
<.> ensures that the date/time specified is in the future.
<.> defaults to 9am tomorrow morning.

Also add in the UI files:

* add a `Pet#visits.columnOrder.txt` file
+
to define which properties of Visit are visible as columns in ``Pet``'s `visits` collection.



=== Optional exercises

NOTE: If you decide to do this optional exercise, make the changes on a git branch so that you can resume with the main flow of exercises later.

. Download a separate `Visit-NN.png` for each of the days of the month (1 to 31), and then use `iconName()` to show a more useful icon based on the `visitAt` date.

. Use choices to provide a set of available date/times, in 15 minutes slots, say.

. Refine the list of slots to filter out any visits that already exist
+
Assume that visits take 15 minutes, and that only on visit can happen at a time.

